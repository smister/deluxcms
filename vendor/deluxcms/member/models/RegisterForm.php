<?php

namespace deluxcms\member\models;

use Yii;

class RegisterForm extends Member
{
    public $verifyCode;

    public function rules()
    {
        return [
            [['username', 'email', 'verifyCode'], 'required', 'message' => '不能为空'],
            ['username', 'match', 'pattern' => '/^[\w]{1,255}$/', 'message' => '用户名只能为1~255的字母或数字'],
            ['username', 'unique', 'message' => '用户名已经被使用'],
            ['email', 'email', 'message' => '邮箱的格式错误'],
            ['email', 'unique', 'message' => '邮箱已经被使用'],
            ['password', 'trim'],
            ['password', 'string', 'min' => 6, 'max' => 255, 'tooShort' => '密码的长度不能小于6位', 'tooLong' => '密码的长度不能大于255'],
            ['repassword', 'compare', 'compareAttribute' => 'password', 'skipOnEmpty' => false, 'message' => '两次密码不一致'],
            ['verifyCode', 'checkCode'],
            //['nickname', 'string', 'max' => 50, 'message' => '昵称的长度不能大于50位'],
            //[['address', 'avatar'], 'string', 'max' => 255, 'message' => '昵称的长度不能大于255位'],
            //['registration_ip', 'string', 'max' => 15, 'message' => '昵称的长度不能大于15位'],
        ];
    }

    public function checkCode($attribute, $params)
    {
        if (!$this->hasErrors() && !Yii::$app->sms->validate($this->email, $this->$attribute)) {
            $this->addError($attribute, '验证码错误');
        }
    }

    public function beforeSave($insert)
    {
        if ($this->password) {
            $this->setPassword($this->password);
        }

        $this->nickname = $this->username;
        $this->registration_ip = Yii::$app->request->getUserIP();
        $this->email_validate = 1;

        return parent::beforeSave($insert); // TODO: Change the autogenerated stub
    }

    public function attributeLabels()
    {
        return array_merge(parent::attributeLabels(), ['verifyCode' => '验证码']);
    }
}